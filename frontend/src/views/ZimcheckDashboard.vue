<template>
  <div class="container">
    <h2>ZimCheck Dashboard</h2>
    <div class="container">
      <div class="row">
        <div class="col btn btn-light position-relative me-1">
          Integrity
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.integrity }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          Empty
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.empty }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          metadata
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.metadata }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          favicon
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.favicon }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          main_page
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.main_page }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          redundant
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.redundant }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          url_internal
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.url_internal }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          url_external
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.url_external }}
          </span>
        </div>
        <div class="col btn btn-light position-relative me-1">
          redirect
          <hr>
          <span class="badge bg-danger">
            {{ checkTotals.redirect }}
          </span>
        </div>
      </div>
    </div>
    <hr>
    <table
      class="table table-sm table-striped table-responsive"
    >
      <thead>
        <tr>
          <th>Scraper</th>
          <th>integrity</th>
          <th>empty</th>
          <th>metadata</th>
          <th>favicon</th>
          <th>main_page</th>
          <th>redundant</th>
          <th>url_internal</th>
          <th>url_external</th>
          <th>redirect</th>
        </tr>
      </thead>
      <tbody>
        <tr
          v-for="(errors, scraper) in checkData"
          id="hide"
          :key="scraper"
        >
          <td>
            {{ scraper }}
          </td>
          <td>
            {{ Math.round((errors.integrity * 100) / checkTotals.integrity) }} %
          </td>
          <td>
            {{ Math.round((errors.empty * 100) / checkTotals.empty) }} %
          </td>
          <td>
            {{ Math.round((errors.metadata * 100) / checkTotals.metadata) }} %
          </td>
          <td>
            {{ Math.round((errors.favicon * 100) / checkTotals.favicon) }} %
          </td>
          <td>
            {{ Math.round((errors.main_page * 100) / checkTotals.main_page) }} %
          </td>
          <td>
            {{ Math.round((errors.redundant * 100) / checkTotals.redundant) }} %
          </td>
          <td>
            {{ Math.round((errors.url_internal * 100) / checkTotals.url_internal) }} %
          </td>
          <td>
            {{ Math.round((errors.url_external * 100) / checkTotals.url_external) }} %
          </td>
          <td>
            {{ Math.round((errors.redirect * 100) / checkTotals.redirect) }} %
          </td>
        </tr>
      </tbody>
    </table>
    <ErrorMessage
      v-if="error"
      :message="error"
    />
  </div>
</template>

<script>
import Common from '../Common.mixin.js'
import ErrorMessage from '../components/ErrorMessage.vue'

export default {
  name: 'ZimcheckDashboard',
  components: {
    ErrorMessage
  },
  mixins: [Common],
  data () {
    return {
      checkData: null,
      checkTotals: null,
      error: null // error message generated by API
    }
  },
  created () {
    const parent = this
    this.startLoading()

    const url = '/dashboard'

    this.queryAPI('GET', url)
      .then(function (response) {
        parent.checkData = response.data.checkData
        parent.checkTotals = response.data.checkTotals
        parent.endLoading()
      })
      .catch(function (error) {
        parent.standardErrorHandling(error)
        parent.endLoading()
      })
  }
}
</script>
